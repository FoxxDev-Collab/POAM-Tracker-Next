import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Separator } from '@/components/ui/separator';
import { RefreshCw } from 'lucide-react';
import { fetchPackageScore, fetchGroupScore } from '@/lib/vulnerability-api';
import { PackageScoreOverview } from '@/components/vulnerability-center/PackageScoreOverview';
import { GroupsStigSummary } from '@/components/vulnerability-center/GroupsStigSummary';

interface PackageScoreSectionProps {
  packageId: number;
  packageName: string;
  groups: Array<{
    id: number;
    name: string;
    description: string | null;
    _count?: {
      systems: number;
    };
  }>;
}

export default async function PackageScoreSection({
  packageId,
  packageName,
  groups
}: PackageScoreSectionProps) {
  // Fetch package score
  const packageScore = await fetchPackageScore(packageId);

  // Fetch group scores
  const groupScorePromises = groups.map(async (group) => {
    const score = await fetchGroupScore(group.id);
    return {
      groupId: group.id,
      groupName: group.name,
      description: group.description,
      totalSystems: group._count?.systems || 0,
      completeAssessments: score?.completeAssessments || 0,
      assessmentProgress: score?.assessmentCompleteness || 0,
      complianceScore: score?.overallCompliance || 0,
      totalFindings: score?.totalFindings || 0,
      openFindings: score?.openFindings || 0,
      notReviewedFindings: score?.notReviewedFindings || 0,
      catIOpen: score?.catIOpen || 0,
      catIIOpen: score?.catIIOpen || 0,
      catIIIOpen: score?.catIIIOpen || 0,
      worstSystemName: score?.worstSystemName,
    };
  });

  const groupStigData = await Promise.all(groupScorePromises);

  if (!packageScore) {
    return (
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle>STIG Compliance Overview</CardTitle>
            <form action={`/api/vulnerability-center/packages/${packageId}/recalculate-score`} method="POST">
              <Button type="submit" variant="outline" size="sm">
                <RefreshCw className="mr-2 h-4 w-4" />
                Calculate Scores
              </Button>
            </form>
          </div>
        </CardHeader>
        <CardContent>
          <p className="text-muted-foreground">
            No STIG compliance data available. Import STIG scans for systems in this package to see compliance scores.
          </p>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header with recalculate button */}
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold">STIG Compliance Overview</h2>
          <p className="text-muted-foreground">
            Compliance is based on the worst-performing group in the package
          </p>
        </div>
        <form action={`/api/vulnerability-center/packages/${packageId}/recalculate-score`} method="POST">
          <Button type="submit" variant="outline" size="sm">
            <RefreshCw className="mr-2 h-4 w-4" />
            Recalculate Scores
          </Button>
        </form>
      </div>

      <Separator />

      {/* Package Score Overview */}
      <PackageScoreOverview
        packageScore={packageScore}
        packageName={packageName}
      />

      {/* Groups Summary */}
      <GroupsStigSummary
        groups={groupStigData}
        packageId={packageId}
      />
    </div>
  );
}