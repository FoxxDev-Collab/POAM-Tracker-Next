'use client';

import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import Link from 'next/link';
import { Monitor, AlertTriangle, CheckCircle, XCircle, AlertCircle } from 'lucide-react';

interface SystemStigData {
  systemId: number;
  systemName: string;
  hostname?: string;
  lastScanDate?: string;
  assessmentProgress: number;
  complianceScore: number;
  totalFindings: number;
  openFindings: number;
  notReviewedFindings: number;
  catIOpen: number;
  catIIOpen: number;
  catIIIOpen: number;
}

interface SystemsStigSummaryProps {
  systems: SystemStigData[];
  packageId: number;
}

export function SystemsStigSummary({ systems, packageId }: SystemsStigSummaryProps) {
  // Ensure systems is a valid array
  const systemsArray = Array.isArray(systems) ? systems : [];

  const getComplianceColor = (score: number) => {
    if (score >= 95) return 'text-green-600 dark:text-green-400';
    if (score >= 80) return 'text-yellow-600 dark:text-yellow-400';
    if (score >= 60) return 'text-orange-600 dark:text-orange-400';
    return 'text-red-600 dark:text-red-400';
  };

  const getStatusBadge = (system: SystemStigData) => {
    if (system.notReviewedFindings > 0) {
      return <Badge variant="secondary">Assessment Incomplete</Badge>;
    }
    if (system.catIOpen > 0) {
      return <Badge variant="destructive">Critical Findings</Badge>;
    }
    if (system.openFindings > 0) {
      return <Badge variant="warning">Open Findings</Badge>;
    }
    if (system.complianceScore >= 95) {
      return <Badge variant="success">Compliant</Badge>;
    }
    return <Badge variant="secondary">Non-Compliant</Badge>;
  };

  const sortedSystems = [...systemsArray].sort((a, b) => {
    // Sort by compliance score (ascending, so worst first)
    return a.complianceScore - b.complianceScore;
  });

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Monitor className="h-5 w-5" />
          Systems STIG Status
        </CardTitle>
      </CardHeader>
      <CardContent>
        {systemsArray.length === 0 ? (
          <p className="text-muted-foreground">No systems with STIG data found.</p>
        ) : (
          <div className="overflow-x-auto">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>System</TableHead>
                  <TableHead>Status</TableHead>
                  <TableHead className="text-center">Compliance</TableHead>
                  <TableHead className="text-center">Assessment</TableHead>
                  <TableHead className="text-center">CAT I</TableHead>
                  <TableHead className="text-center">CAT II</TableHead>
                  <TableHead className="text-center">CAT III</TableHead>
                  <TableHead className="text-center">Total Open</TableHead>
                  <TableHead>Actions</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {sortedSystems.map((system) => (
                  <TableRow key={system.systemId}>
                    <TableCell>
                      <div>
                        <p className="font-medium">{system.systemName}</p>
                        {system.hostname && (
                          <p className="text-xs text-muted-foreground">{system.hostname}</p>
                        )}
                      </div>
                    </TableCell>
                    <TableCell>{getStatusBadge(system)}</TableCell>
                    <TableCell className="text-center">
                      <div className="flex flex-col items-center gap-1">
                        <span className={`font-semibold ${getComplianceColor(system.complianceScore)}`}>
                          {system.complianceScore.toFixed(1)}%
                        </span>
                        <Progress value={system.complianceScore} className="h-1.5 w-16" />
                      </div>
                    </TableCell>
                    <TableCell className="text-center">
                      <div className="flex flex-col items-center gap-1">
                        <span className="text-sm">
                          {system.assessmentProgress.toFixed(0)}%
                        </span>
                        {system.notReviewedFindings > 0 && (
                          <span className="text-xs text-orange-600 dark:text-orange-400">
                            {system.notReviewedFindings} pending
                          </span>
                        )}
                      </div>
                    </TableCell>
                    <TableCell className="text-center">
                      {system.catIOpen > 0 ? (
                        <div className="flex items-center justify-center gap-1">
                          <XCircle className="h-4 w-4 text-red-600 dark:text-red-400" />
                          <span className="font-medium text-red-600 dark:text-red-400">
                            {system.catIOpen}
                          </span>
                        </div>
                      ) : (
                        <span className="text-muted-foreground">0</span>
                      )}
                    </TableCell>
                    <TableCell className="text-center">
                      {system.catIIOpen > 0 ? (
                        <div className="flex items-center justify-center gap-1">
                          <AlertTriangle className="h-4 w-4 text-orange-600 dark:text-orange-400" />
                          <span className="font-medium text-orange-600 dark:text-orange-400">
                            {system.catIIOpen}
                          </span>
                        </div>
                      ) : (
                        <span className="text-muted-foreground">0</span>
                      )}
                    </TableCell>
                    <TableCell className="text-center">
                      {system.catIIIOpen > 0 ? (
                        <div className="flex items-center justify-center gap-1">
                          <AlertCircle className="h-4 w-4 text-yellow-600 dark:text-yellow-400" />
                          <span className="font-medium text-yellow-600 dark:text-yellow-400">
                            {system.catIIIOpen}
                          </span>
                        </div>
                      ) : (
                        <span className="text-muted-foreground">0</span>
                      )}
                    </TableCell>
                    <TableCell className="text-center">
                      <span className={system.openFindings > 0 ? 'font-semibold' : 'text-muted-foreground'}>
                        {system.openFindings}
                      </span>
                    </TableCell>
                    <TableCell>
                      <Link
                        href={`/vulnerability-center/vulnerabilities/systems/${system.systemId}`}
                        className="text-sm text-primary hover:underline"
                      >
                        View Details
                      </Link>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </div>
        )}
      </CardContent>
    </Card>
  );
}